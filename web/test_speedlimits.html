<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Testkart – Fartsgrense Coverage Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .control-box {
      background: white;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      font-size: 14px;
      line-height: 1.4;
    }
    .log-box {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 320px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
    }
    .log-line { margin: 2px 0; }
    .ok { color: #27ae60; }
    .warn { color: #f39c12; }
    .err { color: #c0392b; }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="log" class="log-box">[init] Starter kart…</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.heat plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    /* ---------------------------------------------------------
       LOGGING
    --------------------------------------------------------- */
    const logEl = document.getElementById("log");

    function log(level, msg) {
      const p = document.createElement("p");
      p.className = "log-line " + level;
      const t = new Date().toISOString().slice(11, 19);
      p.innerHTML = `<b>[${t}]</b> ${msg}`;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    /* ---------------------------------------------------------
       INIT MAP
    --------------------------------------------------------- */
    const map = L.map("map").setView([59.4222, 5.4425], 12);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    /* ---------------------------------------------------------
       COLOR FUNCTION
    --------------------------------------------------------- */
    function getColor(limit) {
      if (limit <= 30) return "#2ecc71";
      if (limit <= 50) return "#f1c40f";
      if (limit <= 70) return "#e67e22";
      return "#e74c3c";
    }

    /* ---------------------------------------------------------
       LAYERS
    --------------------------------------------------------- */
    const lineLayer = L.layerGroup().addTo(map);
    const heatPoints = [];
    const heatLayer = L.heatLayer([], {
      radius: 20,
      blur: 15,
      maxZoom: 17
    }).addTo(map);

    /* ---------------------------------------------------------
       LOAD SPEEDLIMITS (IMPROVED)
    --------------------------------------------------------- */
    async function loadSpeedlimits() {
      let part = 1;
      let totalSegments = 0;
      let bounds = [];

      log("ok", "Laster speedlimits…");

      while (true) {
        const url = `../data/speedlimits_part${part}.json`;

        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) {
            log("warn", `Stoppet ved part ${part} (fil finnes ikke)`);
            break;
          }

          const data = await res.json();
          log("ok", `Part ${part}: ${data.length} segmenter`);

          data.forEach(segment => {
            const raw = segment.geometry?.coordinates;
            if (!raw || raw.length < 2) return;

            const coords = raw.map(c => [c[1], c[0]]);

            // Tegn linje
            const poly = L.polyline(coords, {
              color: getColor(segment.speed_limit),
              weight: 4,
              opacity: 0.9
            }).bindPopup(`
              <b>ID:</b> ${segment.id}<br>
              <b>Fartsgrense:</b> ${segment.speed_limit} km/t
            `);

            poly.addTo(lineLayer);

            // Heatmap midpoint
            const mid = coords[Math.floor(coords.length / 2)];
            if (mid) heatPoints.push(mid);

            // Bounds
            coords.forEach(c => bounds.push(c));

            totalSegments++;
          });

          part++;
        } catch (err) {
          log("err", `Feil ved lasting av ${url}: ${err.message}`);
          break;
        }

        if (part > 500) break;
      }

      // Oppdater heatmap
      heatLayer.setLatLngs(heatPoints);

      // Zoom til bounds
      if (bounds.length > 0) {
        map.fitBounds(bounds);
      }

      log("ok", `Totalt lastet: ${totalSegments} segmenter`);
    }

    loadSpeedlimits();

    /* ---------------------------------------------------------
       CONTROL PANEL
    --------------------------------------------------------- */
    const control = L.control({ position: "topright" });

    control.onAdd = function () {
      const div = L.DomUtil.create("div", "control-box");
      div.innerHTML = `
        <label>
          <input type="checkbox" id="toggle-lines" checked />
          Vis linjer
        </label><br>
        <label>
          <input type="checkbox" id="toggle-heat" checked />
          Vis heatmap
        </label>
      `;
      return div;
    };

    control.addTo(map);

    document.getElementById("toggle-lines").addEventListener("change", e => {
      if (e.target.checked) lineLayer.addTo(map);
      else map.removeLayer(lineLayer);
    });

    document.getElementById("toggle-heat").addEventListener("change", e => {
      if (e.target.checked) heatLayer.addTo(map);
      else map.removeLayer(heatLayer);
    });
  </script>
</body>
</html>
