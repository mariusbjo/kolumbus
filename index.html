<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Kollektivdata â€“ SystemverktÃ¸y v1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="web/style.css" />
</head>

<body class="welcome-body">
  <div class="welcome-container">

    <div class="welcome-header">
      <h1>
        Kollektivdata â€“ SystemverktÃ¸y
        <span class="version">v1.0</span>
      </h1>
      <button id="theme-toggle" class="theme-toggle" aria-label="Bytt tema">ğŸŒ“</button>
    </div>

    <p class="welcome-subtitle">Velg et verktÃ¸y for Ã¥ fortsette</p>

    <div class="card-grid">

      <!-- SANNTIDSKART -->
      <a class="tool-card" href="realtime.html">
        <div class="tool-icon">ğŸšŒ</div>
        <div class="tool-title">Sanntidskart</div>
        <div class="tool-desc">Live posisjoner fra Kolumbus, med fartslogging og detaljert ruteinformasjon</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-realtime" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

      <!-- TESTKART -->
      <a class="tool-card" href="web/test_speedlimits.html">
        <div class="tool-icon">ğŸš§</div>
        <div class="tool-title">Fartsgrensekart â€“ Rogaland</div>
        <div class="tool-desc">Heatmap og segmentvisning av fartsgrensedata fra SVV</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-speed" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

      <!-- DASHBOARD -->
      <a class="tool-card" href="dashboard/status.html">
        <div class="tool-icon">ğŸ“Š</div>
        <div class="tool-title">Systemstatus Dashboard</div>
        <div class="tool-desc">Oversikt over datastrÃ¸mmer til sanntidskart og fartsgrensekart</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-dashboard" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

    </div>

    <div class="welcome-updated">
      Sist oppdatert: <span id="last-updated">Lasterâ€¦</span>
    </div>

  </div>

  <script>
    /* ---------------------------------------------------------
       THEME TOGGLE
    --------------------------------------------------------- */
    const html = document.documentElement;
    const toggle = document.getElementById("theme-toggle");

    const stored = localStorage.getItem("welcome-theme");
    if (stored) html.setAttribute("data-theme", stored);

    toggle.addEventListener("click", () => {
      const next = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", next);
      localStorage.setItem("welcome-theme", next);
    });

    /* ---------------------------------------------------------
       LAST UPDATED
    --------------------------------------------------------- */
    async function loadLastUpdated() {
      try {
        const res = await fetch("meta/last_deploy.txt", { cache: "no-store" });
        const epoch = parseInt((await res.text()).trim(), 10);
    
        // Original UTC-tid fra server
        const utcDate = new Date(epoch * 1000);
    
        let date;
    
        try {
          // ForsÃ¸k Ã¥ bruke lokal tid basert pÃ¥ brukerens browser
          date = new Date(utcDate.toLocaleString("en-US", { timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone }));
        } catch {
          // Fallback: UTC+1
          date = new Date(utcDate.getTime() + 1 * 60 * 60 * 1000);
        }
    
        // Format: DD.MM.YYYY
        const dd = String(date.getDate()).padStart(2, "0");
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const yyyy = date.getFullYear();
    
        // Format: HH:MM:SS
        const hh = String(date.getHours()).padStart(2, "0");
        const min = String(date.getMinutes()).padStart(2, "0");
        const ss = String(date.getSeconds()).padStart(2, "0");
    
        const formatted = `${dd}.${mm}.${yyyy} ${hh}:${min}:${ss}`;
    
        document.getElementById("last-updated").textContent = formatted;
    
      } catch {
        document.getElementById("last-updated").textContent = "ukjent";
      }
    }
    
    loadLastUpdated();

    /* ---------------------------------------------------------
       STATUS INDICATORS
       Henter dashboard.json fra gh-pages
    --------------------------------------------------------- */
    function setStatusOk(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = "OK";
      el.classList.remove("status-loading", "status-err");
      el.classList.add("status-ok");
    }

    function setStatusErr(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = "Feil";
      el.classList.remove("status-loading", "status-ok");
      el.classList.add("status-err");
    }

    async function loadStatus() {
      try {
        const res = await fetch("dashboard/dashboard.json", { cache: "no-store" });
        const data = await res.json();

        // Dashboard status
        setStatusOk("status-dashboard");

        // Speedlimits status (basert pÃ¥ hash)
        if (data.hash && data.hash.length > 0) {
          setStatusOk("status-speed");
        } else {
          setStatusErr("status-speed");
        }

        // Realtime status (dummy â€“ kan kobles til API senere)
        setStatusOk("status-realtime");

      } catch {
        setStatusErr("status-dashboard");
        setStatusErr("status-speed");
        setStatusErr("status-realtime");
      }
    }
    loadStatus();
  </script>
</body>
</html>
