<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Kollektivdata â€“ SystemverktÃ¸y v1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="web/style.css" />
</head>

<body class="welcome-body">
  <div class="welcome-container">

    <div class="welcome-header">
      <h1>
        Kollektivdata â€“ SystemverktÃ¸y
        <span class="version">v1.0</span>
      </h1>
      <button id="theme-toggle" class="theme-toggle" aria-label="Bytt tema">ðŸŒ“</button>
    </div>

    <p class="welcome-subtitle">Velg et verktÃ¸y for Ã¥ fortsette</p>

    <div class="card-grid">

      <!-- SANNTIDSKART -->
      <a class="tool-card" href="realtime.html">
        <div class="tool-icon">ðŸšŒ</div>
        <div class="tool-title">Sanntidskart</div>
        <div class="tool-desc">Live posisjoner fra Kolumbus, med fartslogging og detaljert ruteinformasjon</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-realtime" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

      <!-- TESTKART -->
      <a class="tool-card" href="web/test_speedlimits.html">
        <div class="tool-icon">ðŸš§</div>
        <div class="tool-title">Fartsgrensekart â€“ Rogaland</div>
        <div class="tool-desc">Heatmap og segmentvisning av fartsgrensedata fra SVV</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-speed" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

      <!-- DASHBOARD -->
      <a class="tool-card" href="dashboard/status.html">
        <div class="tool-icon">ðŸ“Š</div>
        <div class="tool-title">Systemstatus Dashboard</div>
        <div class="tool-desc">Oversikt over datastrÃ¸mmer til sanntidskart og fartsgrensekart</div>
        <div class="tool-status">
          <span class="label">Status:</span>
          <span id="status-dashboard" class="status-badge status-loading">Lasterâ€¦</span>
        </div>
      </a>

    </div>

    <div class="welcome-updated">
      Sist oppdatert: <span id="last-updated">Lasterâ€¦</span>
    </div>

  </div>

  <script>
    /* ---------------------------------------------------------
       THEME TOGGLE
    --------------------------------------------------------- */
    const html = document.documentElement;
    const toggle = document.getElementById("theme-toggle");

    const stored = localStorage.getItem("welcome-theme");
    if (stored) html.setAttribute("data-theme", stored);

    toggle.addEventListener("click", () => {
      const next = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", next);
      localStorage.setItem("welcome-theme", next);
    });

    /* ---------------------------------------------------------
       LAST UPDATED (lokal tid med fallback til UTC+1)
    --------------------------------------------------------- */
    async function loadLastUpdated() {
      try {
        const res = await fetch("meta/last_deploy.txt", { cache: "no-store" });
        const epoch = parseInt((await res.text()).trim(), 10);

        const utcDate = new Date(epoch * 1000);
        let date;

        try {
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          date = new Date(utcDate.toLocaleString("en-US", { timeZone: tz }));
        } catch {
          date = new Date(utcDate.getTime() + 1 * 3600 * 1000);
        }

        const dd = String(date.getDate()).padStart(2, "0");
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const yyyy = date.getFullYear();

        const hh = String(date.getHours()).padStart(2, "0");
        const min = String(date.getMinutes()).padStart(2, "0");
        const ss = String(date.getSeconds()).padStart(2, "0");

        document.getElementById("last-updated").textContent =
          `${dd}.${mm}.${yyyy} ${hh}:${min}:${ss}`;

      } catch {
        document.getElementById("last-updated").textContent = "ukjent";
      }
    }
    loadLastUpdated();

    /* ---------------------------------------------------------
       STATUS INDICATORS (uten dashboard.json)
    --------------------------------------------------------- */
    function setStatusOk(id) {
      const el = document.getElementById(id);
      el.textContent = "OK";
      el.classList.remove("status-loading", "status-err");
      el.classList.add("status-ok");
    }

    function setStatusErr(id) {
      const el = document.getElementById(id);
      el.textContent = "Feil";
      el.classList.remove("status-loading", "status-ok");
      el.classList.add("status-err");
    }

    async function loadStatus() {
      // Realtime â€“ alltid OK (kan kobles til API senere)
      setStatusOk("status-realtime");

      // Speedlimits â€“ sjekk om speedlimit-filer finnes
      try {
        const test = await fetch("data/speedlimits_part1.json", { cache: "no-store" });
        if (test.ok) {
          setStatusOk("status-speed");
        } else {
          setStatusErr("status-speed");
        }
      } catch {
        setStatusErr("status-speed");
      }

      // Dashboard â€“ lenken fungerer, sÃ¥ OK
      setStatusOk("status-dashboard");
    }

    loadStatus();
  </script>
</body>
</html>
