name: Deploy frontend to GitHub Pages

on:
  workflow_run:
    workflows: ["Fetch Rogaland speed limits and publish frontend", "Fetch Kolumbus data"]
    types: [completed]

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ✅ GH_TOKEN tilgjengelig for ALLE steps som bruker gh CLI
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create public folder
        run: mkdir -p public/data public/meta .cache/speedlimits

      # ---------------------------------------------------------
      # 1) BLOCK MANUAL TRIGGERS (feilsøking)
      # ---------------------------------------------------------
      - name: Block manual triggers
        if: ${{ github.event.workflow_run.event == 'workflow_dispatch' }}
        run: |
          echo "Manuell kjøring oppdaget – deploy avbrytes."
          exit 0

      # ---------------------------------------------------------
      # 2) FINN SISTE RUN AV BEGGE WORKFLOWS
      # ---------------------------------------------------------
      - name: Get latest speedlimits run ID
        id: sl_run
        run: |
          SL=$(gh run list \
            --workflow="Fetch Rogaland speed limits and publish" \
            --branch=main \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion=="success") | .databaseId' \
            | head -n 1)
          echo "id=$SL" >> $GITHUB_OUTPUT

      - name: Get latest kolumbus run ID
        id: ko_run
        run: |
          KO=$(gh run list \
            --workflow="Fetch Kolumbus data" \
            --branch=main \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion=="success") | .databaseId' \
            | head -n 1)
          echo "id=$KO" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) 3-TIMERS KRAV
      # ---------------------------------------------------------
      - name: Check freshness (3-hour window)
        run: |
          NOW=$(date -u +%s)

          SL_TIME=$(gh run view ${{ steps.sl_run.outputs.id }} --json createdAt --jq '.createdAt')
          KO_TIME=$(gh run view ${{ steps.ko_run.outputs.id }} --json createdAt --jq '.createdAt')

          SL_EPOCH=$(date -d "$SL_TIME" +%s)
          KO_EPOCH=$(date -d "$KO_TIME" +%s)

          if [ $((NOW - SL_EPOCH)) -gt 10800 ]; then
            echo "Speedlimits-run er eldre enn 3 timer – avbryter deploy."
            exit 0
          fi

          if [ $((NOW - KO_EPOCH)) -gt 10800 ]; then
            echo "Kolumbus-run er eldre enn 3 timer – avbryter deploy."
            exit 0
          fi

      # ---------------------------------------------------------
      # 4) RESTORE CACHE
      # ---------------------------------------------------------
      - name: Restore speedlimits cache
        id: cache_restore
        uses: actions/cache@v4
        with:
          path: .cache/speedlimits
          key: speedlimits-cache

      # ---------------------------------------------------------
      # 5) LAST NED SPEEDLIMITS-ARTEFAKT (Løsning A)
      # ---------------------------------------------------------
      - name: Download speedlimits artifact
        if: steps.sl_run.outputs.id != ''
        run: |
          rm -rf .cache/speedlimits/*
          gh run download ${{ steps.sl_run.outputs.id }} \
            --name speedlimits-parts \
            --dir .cache/speedlimits

      - name: Save speedlimits cache
        uses: actions/cache@v4
        with:
          path: .cache/speedlimits
          key: speedlimits-cache

      # ---------------------------------------------------------
      # 6) FALLBACK: STOPP HVIS SPEEDLIMITS MANGLER
      # ---------------------------------------------------------
      - name: Validate speedlimits data
        run: |
          if [ -z "$(ls -A .cache/speedlimits)" ]; then
            echo "Ingen speedlimits-data tilgjengelig – avbryter deploy."
            exit 1
          fi

      # ---------------------------------------------------------
      # 7) KOPIER DATA TIL PUBLIC/
      # ---------------------------------------------------------
      - name: Copy speedlimits data
        run: cp .cache/speedlimits/*.json public/data/

      - name: Copy Kolumbus data
        run: |
          cp data/kolumbus.json public/data/ || true
          cp data/debug_entur.json public/data/ || true

      # ---------------------------------------------------------
      # 8) COOLDOWN (maks én deploy per 30 min)
      # ---------------------------------------------------------
      - name: Check cooldown
        run: |
          if [ -f public/meta/last_deploy.txt ]; then
            LAST=$(cat public/meta/last_deploy.txt)
            NOW=$(date -u +%s)
            DIFF=$((NOW - LAST))
            if [ $DIFF -lt 1800 ]; then
              echo "Cooldown aktiv – avbryter deploy."
              exit 0
            fi
          fi

      # ---------------------------------------------------------
      # 9) HASH-BASERT ENDRINGSDETEKSJON
      # ---------------------------------------------------------
      - name: Compute data hash
        id: hash
        run: |
          HASH=$(find public/data -type f -exec sha256sum {} \; | sha256sum | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Compare with previous hash
        run: |
          if [ -f public/meta/last_hash.txt ]; then
            OLD=$(cat public/meta/last_hash.txt)
            if [ "$OLD" = "${{ steps.hash.outputs.hash }}" ]; then
              echo "Ingen endringer i data – avbryter deploy."
              exit 0
            fi
          fi

      # ---------------------------------------------------------
      # 10) GENERER VERSJONERING (status-siden fjernet)
      # ---------------------------------------------------------
      - name: Write version metadata
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{ \"updated\": \"$NOW\" }" > public/meta/version.json
          date -u +%s > public/meta/last_deploy.txt
          echo "${{ steps.hash.outputs.hash }}" > public/meta/last_hash.txt

      # ---------------------------------------------------------
      # 11) KOPIER FRONTEND
      # ---------------------------------------------------------
      - name: Copy frontend files
        run: |
          cp index.html public/
          cp -r assets public/
          cp -r web public/

      # ---------------------------------------------------------
      # 12) DEBUG: VIS INNHOLD I public/
      # ---------------------------------------------------------
      - name: Debug public folder
        run: |
          echo "Innhold i public/:"
          ls -R public

      # ---------------------------------------------------------
      # 13) DEPLOY
      # ---------------------------------------------------------
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
