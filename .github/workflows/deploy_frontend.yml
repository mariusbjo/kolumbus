name: Deploy frontend to GitHub Pages

on:
  workflow_run:
    workflows: ["Fetch Rogaland speed limits", "Fetch Kolumbus data"]
    types: [completed]

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ---------------------------------------------------------
      # 0) CHECKOUT
      # ---------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare folders
        run: mkdir -p public/data public/meta .cache/speedlimits

      # ---------------------------------------------------------
      # 1) BLOCK MANUAL TRIGGERS
      # ---------------------------------------------------------
      - name: Block manual triggers
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Manuell kjøring oppdaget – deploy avbrytes."
          exit 0

      # ---------------------------------------------------------
      # 2) FIND LATEST SUCCESSFUL RUNS
      # ---------------------------------------------------------
      - name: Get latest speedlimits run ID
        id: sl_run
        run: |
          SL=$(gh run list \
            --workflow="Fetch Rogaland speed limits" \
            --branch=main \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion=="success") | .databaseId' \
            | head -n 1)
          echo "id=$SL" >> $GITHUB_OUTPUT

      - name: Get latest kolumbus run ID
        id: ko_run
        run: |
          KO=$(gh run list \
            --workflow="Fetch Kolumbus data" \
            --branch=main \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion=="success") | .databaseId' \
            | head -n 1)
          echo "id=$KO" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) VALIDATE RUN IDS
      # ---------------------------------------------------------
      - name: Validate run IDs
        run: |
          if [ -z "${{ steps.sl_run.outputs.id }}" ]; then
            echo "Ingen vellykket speedlimits-run funnet."
            exit 0
          fi
          if [ -z "${{ steps.ko_run.outputs.id }}" ]; then
            echo "Ingen vellykket kolumbus-run funnet."
            exit 0
          fi

      # ---------------------------------------------------------
      # 4) FRESHNESS CHECK (3 HOURS)
      # ---------------------------------------------------------
      - name: Check freshness (3-hour window)
        run: |
          NOW=$(date -u +%s)
          SL_TIME=$(gh run view ${{ steps.sl_run.outputs.id }} --json createdAt --jq '.createdAt')
          KO_TIME=$(gh run view ${{ steps.ko_run.outputs.id }} --json createdAt --jq '.createdAt')
          SL_EPOCH=$(date -d "$SL_TIME" +%s)
          KO_EPOCH=$(date -d "$KO_TIME" +%s)

          if [ $((NOW - SL_EPOCH)) -gt 10800 ]; then
            echo "Speedlimits-run er eldre enn 3 timer."
            exit 0
          fi

          if [ $((NOW - KO_EPOCH)) -gt 10800 ]; then
            echo "Kolumbus-run er eldre enn 3 timer."
            exit 0
          fi

      # ---------------------------------------------------------
      # 5) RESTORE CACHE
      # ---------------------------------------------------------
      - name: Restore speedlimits cache
        uses: actions/cache@v4
        with:
          path: .cache/speedlimits
          key: speedlimits-cache

      # ---------------------------------------------------------
      # 6) DOWNLOAD ARTIFACT
      # ---------------------------------------------------------
      - name: Download speedlimits artifact
        run: |
          rm -rf .cache/speedlimits/*
          gh run download ${{ steps.sl_run.outputs.id }} \
            --name speedlimits-data \
            --dir .cache/speedlimits

      - name: Save speedlimits cache
        uses: actions/cache@v4
        with:
          path: .cache/speedlimits
          key: speedlimits-cache

      # ---------------------------------------------------------
      # 7) VALIDATE ARTIFACT CONTENT
      # ---------------------------------------------------------
      - name: Validate speedlimits data
        run: |
          if [ -z "$(ls -A .cache/speedlimits)" ]; then
            echo "Ingen speedlimits-data funnet."
            exit 1
          fi

          for f in .cache/speedlimits/*.json; do \
            echo "Validerer $f"; \
            python -c "import json,sys; json.load(open(sys.argv[1]))" "$f"; \
          done

      # ---------------------------------------------------------
      # 8) COPY DATA TO PUBLIC
      # ---------------------------------------------------------
      - name: Copy speedlimits data
        run: cp .cache/speedlimits/*.json public/data/

      - name: Copy Kolumbus data
        run: |
          cp data/kolumbus.json public/data/ || true

      # ---------------------------------------------------------
      # 9) COOLDOWN (30 MIN)
      # ---------------------------------------------------------
      - name: Check cooldown
        run: |
          if [ -f public/meta/last_deploy.txt ]; then
            LAST=$(cat public/meta/last_deploy.txt)
            NOW=$(date -u +%s)
            if [ $((NOW - LAST)) -lt 1800 ]; then
              echo "Cooldown aktiv – avbryter deploy."
              exit 0
            fi
          fi

      # ---------------------------------------------------------
      # 10) HASH-BASED CHANGE DETECTION
      # ---------------------------------------------------------
      - name: Compute data hash
        id: hash
        run: |
          HASH=$(find public/data -type f -exec sha256sum {} \; | sha256sum | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Compare with previous hash
        run: |
          if [ -f public/meta/last_hash.txt ]; then
            OLD=$(cat public/meta/last_hash.txt)
            if [ "$OLD" = "${{ steps.hash.outputs.hash }}" ]; then
              echo "Ingen endringer i data – avbryter deploy."
              exit 0
            fi
          fi

      # ---------------------------------------------------------
      # 11) WRITE METADATA
      # ---------------------------------------------------------
      - name: Write version metadata
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{ \"updated\": \"$NOW\" }" > public/meta/version.json
          date -u +%s > public/meta/last_deploy.txt
          echo "${{ steps.hash.outputs.hash }}" > public/meta/last_hash.txt

      # ---------------------------------------------------------
      # 12) COPY FRONTEND
      # ---------------------------------------------------------
      - name: Copy frontend files
        run: |
          cp index.html public/
          cp -r assets public/ || true
          cp -r scripts public/ || true
          cp -r web public/ || true
          cp -r dashboard public/ || true

      # ---------------------------------------------------------
      # 13) DEBUG
      # ---------------------------------------------------------
      - name: Debug public folder
        run: ls -R public

      # ---------------------------------------------------------
      # 14) DEPLOY
      # ---------------------------------------------------------
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          keep_files: false
          enable_jekyll: false
