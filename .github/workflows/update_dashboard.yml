name: Update Enterprise Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Block manual triggers
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Manuell kjøring oppdaget – avbryter."
          exit 0

      - name: Prepare public folder
        run: mkdir -p public/dashboard public/dashboard/assets

      # ---------------------------------------------------------
      # 1) VALIDATE TEMPLATE
      # ---------------------------------------------------------
      - name: Validate dashboard template
        run: |
          if [ ! -f dashboard/status.html.template ]; then
            echo "Template mangler."
            exit 1
          fi

      # ---------------------------------------------------------
      # 2) BUILD DASHBOARD
      # ---------------------------------------------------------
      - name: Build dashboard from template
        id: build
        run: |
          VERSION=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          HASH=$(sha256sum dashboard/status.html.template | awk '{print $1}')

          sed \
            -e "s|{{VERSION}}|$VERSION|g" \
            -e "s|{{HASH}}|$HASH|g" \
            dashboard/status.html.template \
            > public/dashboard/status.html

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) GENERATE METADATA
      # ---------------------------------------------------------
      - name: Generate dashboard metadata
        run: |
          cat > public/dashboard/dashboard.json <<EOF
          {
            "version": "${{ steps.build.outputs.version }}",
            "hash": "${{ steps.build.outputs.hash }}",
            "generated": "${{ steps.build.outputs.version }}"
          }
          EOF

      # ---------------------------------------------------------
      # 4) COPY ASSETS
      # ---------------------------------------------------------
      - name: Copy dashboard assets
        run: |
          cp -r dashboard/assets/* public/dashboard/assets/ || true

      # ---------------------------------------------------------
      # 5) VALIDATE ASSETS
      # ---------------------------------------------------------
      - name: Validate dashboard assets
        run: |
          for f in public/dashboard/assets/*; do
            [ -f "$f" ] || continue
            size=$(stat -c%s "$f")
            if [ "$size" -gt 100000000 ]; then
              echo "Asset $f er for stor."
              exit 1
            fi
          done

      # ---------------------------------------------------------
      # 6) CHECK EXISTING DASHBOARD IN GH-PAGES
      # ---------------------------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp

      - name: Compare dashboard with existing version
        id: diff
        run: |
          if [ -f ghp/dashboard/status.html ]; then
            if diff -q public/dashboard/status.html ghp/dashboard/status.html > /dev/null; then
              echo "changed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "changed=true" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 7) STOP IF NO CHANGE
      # ---------------------------------------------------------
      - name: Stop if no changes
        if: steps.diff.outputs.changed == 'false'
        run: |
          echo "Ingen endringer – avbryter."
          exit 0

      # ---------------------------------------------------------
      # 8) DEPLOY DASHBOARD ONLY
      # ---------------------------------------------------------
      - name: Deploy updated dashboard
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          keep_files: true
          enable_jekyll: false
