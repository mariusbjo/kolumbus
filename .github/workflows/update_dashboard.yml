name: Update Enterprise Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # Hver 30. minutt

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # CHECKOUT MAIN BRANCH
      # ---------------------------------------------------------
      - name: Checkout repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # BLOCK MANUAL RUNS
      # ---------------------------------------------------------
      - name: Block manual triggers
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Manuell kjÃ¸ring oppdaget â€“ avbryter."
          exit 0

      # ---------------------------------------------------------
      # PREPARE OUTPUT FOLDERS
      # ---------------------------------------------------------
      - name: Prepare public folder
        run: mkdir -p public/dashboard public/dashboard/assets

      # ---------------------------------------------------------
      # 1) VALIDATE TEMPLATE EXISTS
      # ---------------------------------------------------------
      - name: Validate dashboard template
        run: |
          if [ ! -f dashboard/status.html.template ]; then
            echo "âŒ Template mangler."
            exit 1
          fi

      # ---------------------------------------------------------
      # 2) BUILD DASHBOARD FROM TEMPLATE
      # ---------------------------------------------------------
      - name: Build dashboard from template
        id: build
        run: |
          VERSION=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          HASH=$(sha256sum dashboard/status.html.template | awk '{print $1}')

          sed \
            -e "s|{{VERSION}}|$VERSION|g" \
            -e "s|{{HASH}}|$HASH|g" \
            dashboard/status.html.template \
            > public/dashboard/status.html

          # ðŸ”¥ Fail if placeholders remain
          if grep -q "{{VERSION}}" public/dashboard/status.html || grep -q "{{HASH}}" public/dashboard/status.html; then
            echo "âŒ Template ble ikke rendret riktig â€“ placeholders finnes fortsatt."
            echo "ðŸ” FÃ¸rste 20 linjer av generert fil:"
            head -n 20 public/dashboard/status.html
            exit 1
          fi

          echo "ðŸ” FÃ¸rste 20 linjer av generert dashboard:"
          head -n 20 public/dashboard/status.html

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3) GENERATE METADATA JSON
      # ---------------------------------------------------------
      - name: Generate dashboard metadata
        run: |
          cat > public/dashboard/dashboard.json <<EOF
          {
            "version": "${{ steps.build.outputs.version }}",
            "hash": "${{ steps.build.outputs.hash }}",
            "generated": "${{ steps.build.outputs.version }}"
          }
          EOF

          # Validate JSON
          python3 - <<EOF
import json
json.load(open("public/dashboard/dashboard.json"))
EOF

      # ---------------------------------------------------------
      # 4) COPY ASSETS
      # ---------------------------------------------------------
      - name: Copy dashboard assets
        run: |
          if [ -d dashboard/assets ]; then
            cp -r dashboard/assets/* public/dashboard/assets/ || true
          fi

      # ---------------------------------------------------------
      # 5) VALIDATE ASSETS
      # ---------------------------------------------------------
      - name: Validate dashboard assets
        run: |
          for f in public/dashboard/assets/*; do
            [ -f "$f" ] || continue
            size=$(stat -c%s "$f")
            if [ "$size" -gt 100000000 ]; then
              echo "âŒ Asset $f er for stor."
              exit 1
            fi
          done

      # ---------------------------------------------------------
      # 6) CHECK EXISTING DASHBOARD IN GH-PAGES
      # ---------------------------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp
          fetch-depth: 1

      - name: Compare dashboard with existing version
        id: diff
        run: |
          if [ -f ghp/dashboard/status.html ] && diff -q public/dashboard/status.html ghp/dashboard/status.html > /dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "changed=true" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 7) STOP IF NO CHANGE
      # ---------------------------------------------------------
      - name: Stop if no changes
        if: steps.diff.outputs.changed == 'false'
        run: |
          echo "Ingen endringer â€“ avbryter."
          exit 0

      # ---------------------------------------------------------
      # 8) DEPLOY UPDATED DASHBOARD
      # ---------------------------------------------------------
      - name: Deploy updated dashboard
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          keep_files: true
          enable_jekyll: false
